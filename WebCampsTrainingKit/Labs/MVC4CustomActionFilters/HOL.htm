
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Web Camps Training Kit - Home</title>
    <link rel="Stylesheet" type="text/css" media="all" href="styles/master.css" />
</head>
<body>
    <div id="outerWrapper">
        <div id="wrapper" class="landingPage getStartedPage">
            <div id="whiteBkgdStrip">
            </div>
            <div class="header">
                <div class="heading">
					<div class="mainHomepageTitle"></div>
					<div class="logo-image"></div>
					<div class="header-landscape landscape-image"></div>
				<!--	<div class="clear"></div>-->
				</div>
				<div class="nav-menu-header">
					<div class="AspNet-Menu-Horizontal" id="ctl00_TopNavMenu">
						<ul class="AspNet-Menu">
							<li class="AspNet-Menu-Leaf AspNet-Menu-Selected">
								<a id="leftMenu" class="AspNet-Menu-Link AspNet-Menu-Selected" href="#">Content</a>
							</li>
							<li class="AspNet-Menu-Leaf">
								<a id="rightMenu" class="AspNet-Menu-Link" href="Source">Setup</a>
							</li>
						</ul>
					</div>
				</div>
            </div>		
            <div class="contentWrapper">
			<a name="top"></a>


<div class="genericInnerWrapper">
		<div class="content">
			<?xml version="1.0" encoding="iso-8859-1"?><span><p><a name="HOLTop"></a></p>

<h1 id="ASPNET_MVC_4_Custom_Action_Filters">ASP.NET MVC 4 Custom Action Filters</h1>

<hr />

<p><a name="Overview"></a></p>

<h2 id="Overview">Overview</h2>

<p>ASP.NET MVC provides Action Filters for executing filtering logic either before or after an action method is called. Action Filters are custom attributes that provide declarative means to add pre-action and post-action behavior to the controller's action methods.</p>

<p>In this Hands-on Lab you will create a custom action filter attribute into MvcMusicStore solution to catch controller's requests and log the activity of a site into a database table. You will be able to add your logging filter by injection to any controller or action.  Finally, you will see the log view that shows the list of visitors.</p>
<blockquote>
<p><strong>Note:</strong> This Hands-on Lab assumes you have basic knowledge of <strong>ASP.NET MVC</strong>. If you have not used <strong>ASP.NET MVC</strong> before, we recommend you to go over <strong>ASP.NET MVC 4 Fundamentals</strong> Hands-on Lab.</p>
</blockquote>
<p><a name="Objectives"></a></p>

<h3 id="Objectives">Objectives</h3>

<p>In this Hands-On Lab, you will learn how to:</p>

<ul>
<li><p>Create a custom action filter attribute to extend filtering capabilities</p></li>
<li><p>Apply a custom filter attribute by injection to a specific level</p></li>
<li><p>Register a custom action filters globally</p></li>
</ul>

<p><a name="Prerequisites"></a> </p>

<h3 id="Prerequisites">Prerequisites</h3>

<p>You must have the following items to complete this lab:</p>

<ul>
<li><a href="http://www.microsoft.com/visualstudio/eng/products/visual-studio-express-for-web">Microsoft Visual Studio Express 2012 for Web</a> or superior (read <a href="#AppendixA">Appendix A</a> for instructions on how to install it).</li>
</ul>

<p><a name="Setup"></a> </p>

<h3 id="Setup">Setup</h3>

<p><strong>Installing Code Snippets</strong></p>

<p>For convenience, much of the code you will be managing along this lab is available as Visual Studio code snippets. To install the code snippets run <strong>.\Source\Setup\CodeSnippets.vsi</strong> file.</p>

<p>If you are not familiar with the Visual Studio Code Snippets, and want to learn how to use them, you can refer to the appendix from this document &quot;<a href="#AppendixC">Appendix C: Using Code Snippets</a>&quot;.</p>

<hr />

<p><a name="Exercises"></a> </p>

<h2 id="Exercises">Exercises</h2>

<p>This Hands-On Lab is comprised by the following exercises:</p>

<ol>
<li><a href="#Exercise1">Exercise 1: Logging actions</a></li>
<li><a href="#Exercise2">Exercise 2: Managing Multiple Action Filters</a></li>
</ol>

<p>Estimated time to complete this lab: <strong>30 minutes</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Each exercise is accompanied by an <strong>End</strong> folder containing the resulting solution you should obtain after completing the exercises. You can use this solution as a guide if you need additional help working through the exercises.</p>
</blockquote>
<p><a name="Exercise1"></a> </p>

<h3 id="Exercise_1_Logging_Actions">Exercise 1: Logging Actions</h3>

<p>In this exercise, you will learn how to create a custom action log filter by using ASP.NET MVC 4 Filter Providers.  For that purpose you will apply a logging filter to the MusicStore site that will record all the activities in the selected controllers.</p>

<p>The filter will extend <strong>ActionFilterAttributeClass</strong> and override <strong>OnActionExecuting</strong> method to catch each request and then perform the logging actions. The context information about HTTP requests, executing methods, results and parameters will be provided by ASP.NET MVC <strong>ActionExecutingContext</strong> class<strong>.</strong></p>
<blockquote>
<p><strong>Note:</strong> ASP.NET MVC 4 also has default filters providers you can use without creating a custom filter. ASP.NET MVC 4 provides the following types of filters:</p>

<ul>
<li><strong>Authorization</strong> filter, which makes security decisions about whether to execute an action method, such as performing authentication or validating properties of the request. </li>
<li><strong>Action</strong> filter, which wraps the action method execution. This filter can perform additional processing, such as providing extra data to the action method, inspecting the return value, or canceling execution of the action method</li>
<li><strong>Result</strong> filter, which wraps execution of the ActionResult object. This filter can perform additional processing of the result, such as modifying the HTTP response. </li>
<li><strong>Exception</strong> filter, which executes if there is an unhandled exception thrown somewhere in action method, starting with the authorization filters and ending with the execution of the result. Exception filters can be used for tasks such as logging or displaying an error page.</li>
</ul>

<p>For more information about Filters Providers please visit this MSDN link: (<a href="http://msdn.microsoft.com/en-us/library/dd410209.aspx">http://msdn.microsoft.com/en-us/library/dd410209.aspx</a>) .</p>
</blockquote>
<p><a name="AboutLoggingFeature"></a> </p>

<h4 id="About_MVC_Music_Store_Application_logging_feature">About MVC Music Store Application logging feature</h4>

<p>This Music Store solution has a new data model table for site logging, <strong>ActionLog</strong>, with the following fields: Name of the controller that received a request, Called action, Client IP and Time stamp.</p>

<p><img src="./images/Data-model.-ActionLog-table..png?raw=true" alt="Data model. ActionLog table." title="Data model. ActionLog table." />
</p>

<p><em>Data model - ActionLog table</em></p>

<p>The solution provides an ASP.NET MVC View for the Action log that can be found at <strong>MvcMusicStores/Views/ActionLog</strong>:</p>

<p><img src="./images/Action-Log-view.png?raw=true" alt="Action Log view" title="Action Log view" />
</p>

<p><em>Action Log view</em></p>

<p>With this given structure, all the work will be focused on interrupting controller's request and performing the logging by using custom filtering.</p>

<p><a name="Ex1Task1"></a></p>

<h4 id="Task_1_-_Creating_a_Custom_Filter_to_Catch_a_Controllers_Request">Task 1 - Creating a Custom Filter to Catch a Controller's Request</h4>

<p>In this task you will create a custom filter attribute class that will contain the logging logic. For that purpose you will extend ASP.NET MVC <strong>ActionFilterAttribute</strong> Class and implement the interface <strong>IActionFilter</strong>.</p>
<blockquote>
<p><strong>Note:</strong> The <strong>ActionFilterAttribute</strong> is the base class for all the attribute filters. It provides the following methods to execute a specific logic after and before controller action's execution:</p>

<ul>
<li><strong>OnActionExecuting</strong>(ActionExecutedContext filterContext): Just before the action method is called.</li>
<li><strong>OnActionExecuted</strong>(ActionExecutingContext filterContext): After the action method is called and before the result is executed (before view render).</li>
<li><strong>OnResultExecuting</strong>(ResultExecutingContext filterContext): Just before the result is executed (before view render).</li>
<li><strong>OnResultExecuted</strong>(ResultExecutedContext filterContext): After the result is executed (after the view is rendered).</li>
</ul>

<p>By overriding any of these methods into a derived class, you can execute your own filtering code.</p>
</blockquote>
<ol>
<li><p>Open the <strong>Begin</strong> solution located at <strong>\Source\Ex01-LoggingActions\Begin</strong> folder.</p>

<ol>
<li>You will need to download some missing NuGet packages before continue. To do this, click the <strong>Project</strong> menu and select <strong>Manage NuGet Packages</strong>.</li>
<li>In the <strong>Manage NuGet Packages</strong> dialog, click <strong>Restore</strong> in order to download missing packages.</li>
<li>Finally, build the solution by clicking <strong>Build</strong> | <strong>Build Solution</strong>.</li>
</ol>
<blockquote>
<p><strong>Note:</strong> One of the advantages of using NuGet is that you don't have to ship all the libraries in your project, reducing the project size. With NuGet Power Tools, by specifying the package versions in the Packages.config file, you will be able to download all the required libraries the first time you run the project. This is why you will have to run these steps after you open an existing solution from this lab.</p>

<p>For more information, see this article: <a href="http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages">http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages</a>.</p>
</blockquote></li>
<li><p>Add a new C# class into the <strong>Filters</strong> folder and name it <em>CustomActionFilter.cs</em>. This folder will store all the custom filters.</p></li>
<li><p>Open <strong>CustomActionFilter.cs</strong> and add a reference to <strong>System.Web.Mvc</strong> and  <strong>MvcMusicStore.Models</strong> namespaces:</p>

<p>(Code Snippet - <em>ASP.NET MVC 4 Custom Action Filters - Ex1-CustomActionFilterNamespaces</em>)</p>

<!-- mark:5-6    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System;
<span style="color:#0000FF">using</span> System.Collections.Generic;
<span style="color:#0000FF">using</span> System.Linq;
<span style="color:#0000FF">using</span> System.Web;
<strong class="markLine"><span style="color:#0000FF">using</span> System.Web.Mvc;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> MvcMusicStore.Models;</strong>
</code></pre></li>
<li><p>Inherit the <strong>CustomActionFilter</strong> class from <strong>ActionFilterAttribute</strong> and then make <strong>CustomActionFilter</strong> class implement <strong>IActionFilter</strong> interface.</p>

<!-- mark:4    -->

<span class="codelanguage">C#</span><pre><code class="C#">...
<span style="color:#0000FF">namespace</span> MvcMusicStore.Filters
{
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> CustomActionFilter : ActionFilterAttribute, IActionFilter</strong>
    {
        ...
</code></pre></li>
<li><p>Make <strong>CustomActionFilter</strong> class override the method <strong>OnActionExecuting</strong> and add the necessary logic to log the filter's execution. To do this, add the following highlighted code within <strong>CustomActionFilter</strong> class.</p>

<p>(Code Snippet - <em>ASP.NET MVC 4 Custom Action Filters - Ex1-LoggingActions</em>)</p>

<!-- mark:3-22    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> CustomActionFilter : ActionFilterAttribute, IActionFilter
{
<strong class="markLine">    <span style="color:#0000FF">void</span> IActionFilter.OnActionExecuting(ActionExecutingContext filterContext)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#008000">// TODO: Add your acction filter&#39;s tasks here</span></strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#008000">// Log Action Filter Call</span></strong>
<strong class="markLine">        MusicStoreEntities storeDB = <span style="color:#0000FF">new</span> MusicStoreEntities();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        ActionLog log = <span style="color:#0000FF">new</span> ActionLog()</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            Controller = filterContext.ActionDescriptor.ControllerDescriptor.ControllerName,</strong>
<strong class="markLine">            Action = filterContext.ActionDescriptor.ActionName + <span style="color:#8B0000">&quot; (Logged By: Custom Action Filter)&quot;</span>,</strong>
<strong class="markLine">            IP = filterContext.HttpContext.Request.UserHostAddress,</strong>
<strong class="markLine">            DateTime = filterContext.HttpContext.Timestamp</strong>
<strong class="markLine">        };</strong>
<strong class="markLine"></strong>
<strong class="markLine">        storeDB.ActionLogs.Add(log);</strong>
<strong class="markLine">        storeDB.SaveChanges();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.OnActionExecuting(filterContext);</strong>
<strong class="markLine">    }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong>  <strong>OnActionExecuting</strong> method is using <strong>Entity Framework</strong> to add a new ActionLog register.  It creates and fills a new entity instance with the context information from <strong>filterContext</strong>. </p>

<p>You can read more about <strong>ControllerContext</strong> class at <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.controllercontext.aspx">msdn</a>.</p>
</blockquote></li>
</ol>

<p><a name="Ex1Task2"></a></p>

<h4 id="Task_2_-_Injecting_a_Code_Interceptor_into_the_Store_Controller_Class">Task 2 - Injecting a Code Interceptor into the Store Controller Class</h4>

<p>In this task you will add the custom filter by injecting it to all controller classes and controller actions that will be logged. For the purpose of this exercise, the Store Controller class will have a log.</p>

<p>The method <strong>OnActionExecuting</strong> from <strong>ActionLogFilterAttribute</strong> custom filter runs when an injected element is called.</p>

<p>It is also possible to intercept a specific controller method.</p>

<ol>
<li><p>Open the <strong>StoreController</strong> at <strong>MvcMusicStore\Controllers</strong> and add a reference to the <strong>Filters</strong> namespace:</p>

<!-- mark:4    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System.Linq;
<span style="color:#0000FF">using</span> System.Web.Mvc;
<span style="color:#0000FF">using</span> MvcMusicStore.Models;
<strong class="markLine"><span style="color:#0000FF">using</span> MvcMusicStore.Filters;</strong>
</code></pre></li>
<li><p>Inject the custom filter <strong>CustomActionFilter</strong> into <strong>StoreController</strong> class by adding <strong>[CustomActionFilter]</strong> attribute before the class declaration. </p>

<!-- mark:2    -->

<span class="codelanguage">C#</span><pre><code class="C#">...
<strong class="markLine">[CustomActionFilter]</strong>
<span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> StoreController : Controller
{
    ...
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> When a filter is injected into a controller class, all its actions are also injected. If you would like to apply the filter only for a set of actions, you would have to inject <strong>[CustomActionFilter]</strong> to each one of them:</p>

<span class="codelanguage">C#</span><pre><code class="C#">[CustomActionFilter]
<span style="color:#0000FF">public</span> ActionResult Index()
{
  ...
}

[CustomActionFilter]
<span style="color:#0000FF">public</span> ActionResult Browse(<span style="color:#0000FF">string</span> genre)
{
  ...
}
</code></pre>
</blockquote></li>
</ol>

<p><a name="Ex1Task3"></a></p>

<h4 id="Task_3_-_Running_the_Application">Task 3 - Running the Application</h4>

<p>In this task, you will test that the logging filter is working. You will start the application and visit the store, and then you will check logged activities.</p>

<ol>
<li><p>Press <strong>F5</strong> to run the application.</p></li>
<li><p>Browse to <strong>/ActionLog</strong> to see log view initial state:</p>

<p><img src="./images/Log-tracker-status-before-page-activity.png?raw=true" alt="Log tracker status before page activity" title="Log tracker status before page activity" />
</p>

<p><em>Log tracker status before page activity</em></p>
<blockquote>
<p><strong>Note:</strong> By default, it will always show one item that is generated when retrieving the existing genres for the menu.</p>

<p>For simplicity purposes we're cleaning up the <strong>ActionLog</strong> table each time the application runs so it will only show the logs of each particular task's verification.</p>

<p>You might need to remove the following code from the <strong>Session_Start</strong> method (in the <strong>Global.asax</strong> class), in order to save an historical log for all the actions executed within the Store Controller.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#008000">// Clean up Logs Table</span>
MusicStoreEntities storeDB = <span style="color:#0000FF">new</span> MusicStoreEntities();
<span style="color:#0000FF">foreach</span> (<span style="color:#0000FF">var</span> log <span style="color:#0000FF">in</span> storeDB.ActionLogs.ToList())
{
   storeDB.ActionLogs.Remove(log);
}

storeDB.SaveChanges();
</code></pre>
</blockquote></li>
<li><p>Click one of the <strong>Genres</strong> from the menu and perform some actions there, like browsing an available album.</p></li>
<li><p>Browse to <strong>/ActionLog</strong> and if the log is empty press <strong>F5</strong> to refresh the page. Check that your visits were tracked:</p>

<p><img src="./images/Action-log-with-activity-logged.png?raw=true" alt="Action log with activity logged" title="Action log with activity logged" />
</p>

<p><em>Action log with activity logged</em></p></li>
</ol>

<p><a name="Exercise2"></a></p>

<h3 id="Exercise_2_Managing_Multiple_Action_Filters">Exercise 2: Managing Multiple Action Filters</h3>

<p>In this exercise you will add a second Custom Action Filter to the StoreController class and define the specific order in which both filters will be executed. Then you will update the code to register the filter Globally.</p>

<p>There are different options to take into account when defining the Filters' execution order. For example, the Order property and the Filters' scope:</p>

<p>You can define a <strong>Scope</strong> for each of the Filters, for example, you could scope all the Action Filters to run within the <strong>Controller Scope</strong>, and all Authorization Filters to run in <strong>Global scope</strong>. The scopes have a defined execution order.</p>

<p>Additionally, each action filter has an Order property which is used to determine the execution order in the scope of the filter.</p>

<p>For more information about Custom Action Filters execution order, please visit this MSDN article: (<a href="http://msdn.microsoft.com/en-us/library/dd381609%28v=vs.98%29.aspx">http://msdn.microsoft.com/en-us/library/dd381609%28v=vs.98%29.aspx</a>).</p>

<p><a name="Ex2Task1"></a></p>

<h4 id="Task_1_Creating_a_new_Custom_Action_Filter">Task 1: Creating a new Custom Action Filter</h4>

<p>In this task, you will create a new Custom Action Filter to inject into the StoreController class, learning how to manage the execution order of the filters.</p>

<ol>
<li><p>Open the <strong>Begin</strong> solution located at <strong>\Source\Ex02-ManagingMultipleActionFilters\Begin</strong> folder. Otherwise, you might continue using the <strong>End</strong> solution obtained by completing the previous exercise.</p>

<ol>
<li>If you opened the provided <strong>Begin</strong> solution, you will need to download some missing NuGet packages before continue. To do this, click the <strong>Project</strong> menu and select <strong>Manage NuGet Packages</strong>.</li>
<li>In the <strong>Manage NuGet Packages</strong> dialog, click <strong>Restore</strong> in order to download missing packages.</li>
<li><p>Finally, build the solution by clicking <strong>Build</strong> | <strong>Build Solution</strong>.</p>
<blockquote>
<p><strong>Note:</strong> One of the advantages of using NuGet is that you don't have to ship all the libraries in your project, reducing the project size. With NuGet Power Tools, by specifying the package versions in the Packages.config file, you will be able to download all the required libraries the first time you run the project. This is why you will have to run these steps after you open an existing solution from this lab.</p>

<p>For more information, see this article: <a href="http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages">http://docs.nuget.org/docs/workflows/using-nuget-without-committing-packages</a>.</p>
</blockquote></li>
</ol></li>
<li><p>Add a new C# class into the <strong>Filters</strong> folder and name it  <em>MyNewCustomActionFilter.cs</em></p></li>
<li><p>Open <strong>MyNewCustomActionFilter.cs</strong> and add a reference to <strong>System.Web.Mvc</strong> and the <strong>MvcMusicStore.Models</strong> namespace:</p>

<p>(Code Snippet - <em>ASP.NET MVC 4 Custom Action Filters - Ex2-MyNewCustomActionFilterNamespaces</em>)</p>

<!-- mark:5-6    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System;
<span style="color:#0000FF">using</span> System.Collections.Generic;
<span style="color:#0000FF">using</span> System.Linq;
<span style="color:#0000FF">using</span> System.Web;
<strong class="markLine"><span style="color:#0000FF">using</span> System.Web.Mvc;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> MvcMusicStore.Models;</strong>
</code></pre></li>
<li><p>Replace the default class declaration with the following code.</p>

<p>(Code Snippet - <em>ASP.NET MVC 4 Custom Action Filters - Ex2-MyNewCustomActionFilterClass</em>)</p>

<!-- mark:1-23    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> MyNewCustomActionFilter : ActionFilterAttribute, IActionFilter</strong>
<strong class="markLine">{</strong>
<strong class="markLine">  <span style="color:#0000FF">void</span> IActionFilter.OnActionExecuting(ActionExecutingContext filterContext)</strong>
<strong class="markLine">  {</strong>
<strong class="markLine">        <span style="color:#008000">// TODO: Add your acction filter&#39;s tasks here</span></strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#008000">// Log Action Filter Call</span></strong>
<strong class="markLine">        MusicStoreEntities storeDB = <span style="color:#0000FF">new</span> MusicStoreEntities();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        ActionLog log = <span style="color:#0000FF">new</span> ActionLog()</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">             Controller = filterContext.ActionDescriptor.ControllerDescriptor.ControllerName,</strong>
<strong class="markLine">             Action = filterContext.ActionDescriptor.ActionName + <span style="color:#8B0000">&quot; (Logged By: MyNewCustomActionFilter)&quot;</span>,</strong>
<strong class="markLine">             IP = filterContext.HttpContext.Request.UserHostAddress,</strong>
<strong class="markLine">             DateTime = filterContext.HttpContext.Timestamp</strong>
<strong class="markLine">        };</strong>
<strong class="markLine"></strong>
<strong class="markLine">        storeDB.ActionLogs.Add(log);</strong>
<strong class="markLine">        storeDB.SaveChanges();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.OnActionExecuting(filterContext);</strong>
<strong class="markLine">  }</strong>
<strong class="markLine">}</strong>
</code></pre>
<blockquote>
<p><strong>Note:</strong> This Custom Action Filter is almost the same than the one you created in the previous exercise. The main difference is that it has the <em>&quot;Logged By&quot;</em> attribute updated with this new class' name to identify wich filter registered the log.</p>
</blockquote></li>
</ol>

<p><a name="Ex2Task2"></a></p>

<h4 id="Task_2_Injecting_a_new_Code_Interceptor_into_the_StoreController_Class">Task 2: Injecting a new Code Interceptor into the StoreController Class</h4>

<p>In this task, you will add a new custom filter into the StoreController Class and run the solution to verify how both filters work together.</p>

<ol>
<li><p>Open the <strong>StoreController</strong> class located at <strong>MvcMusicStore\Controllers</strong> and inject the new custom filter <strong>MyNewCustomActionFilter</strong> into <strong>StoreController</strong> class like is shown in the following code.</p>

<!-- mark:1    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[MyNewCustomActionFilter]</strong>
[CustomActionFilter]
<span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> StoreController : Controller
{
...
}
</code></pre></li>
<li><p>Now, run the application in order to see how these two Custom Action Filters work. To do this, press <strong>F5</strong> and wait until the application starts.</p></li>
<li><p>Browse to <strong>/ActionLog</strong> to see log view initial state.</p>

<p><img src="./images/Log-tracker-status-before-page-activity2.png?raw=true" alt="Log tracker status before page activity" title="Log tracker status before page activity" />
</p>

<p><em>Log tracker status before page activity</em></p></li>
<li><p>Click one of the <strong>Genres</strong> from the menu and perform some actions there, like browsing an available album.</p></li>
<li><p>Check that this time; your visits were tracked twice: once for each of the Custom Action Filters you added in the <strong>StorageController</strong> class.</p>

<p><img src="./images/Action-log-with-activity-logged2.png?raw=true" alt="Action log with activity logged" title="Action log with activity logged" />
</p>

<p><em>Action log with activity logged</em></p></li>
<li><p>Close the browser.</p></li>
</ol>

<p><a name="Ex2Task3"></a></p>

<h4 id="Task_3_Managing_Filter_Ordering">Task 3: Managing Filter Ordering</h4>

<p>In this task, you will learn how to manage the filters' execution order by using the Order propery.</p>

<ol>
<li><p>Open the <strong>StoreController</strong> class located at <strong>MvcMusicStore\Controllers</strong> and specify the <strong>Order</strong> property in both filters like shown below.</p>

<!-- mark:1-2    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[MyNewCustomActionFilter(Order = 2)]</strong>
<strong class="markLine">[CustomActionFilter(Order = 1)]</strong>
<span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> StoreController : Controller
{
...
}
</code></pre></li>
<li><p>Now, verify how the filters are executed depending on its Order property's value. You will find that the filter with the smallest Order value (<strong>CustomActionFilter</strong>) is the first one that is executed. Press <strong>F5</strong> and wait until the application starts.</p></li>
<li><p>Browse to <strong>/ActionLog</strong> to see log view initial state.</p>

<p><img src="./images/Log-tracker-status-before-page-activity2.png?raw=true" alt="Log tracker status before page activity" title="Log tracker status before page activity" />
</p>

<p><em>Log tracker status before page activity</em></p></li>
<li><p>Click one of the <strong>Genres</strong> from the menu and perform some actions there, like browsing an available album.</p></li>
<li><p>Check that this time, your visits were tracked ordered by the filters' Order value: <strong>CustomActionFilter</strong> logs' first.</p>

<p><img src="./images/Action-log-with-activity-logged3.png?raw=true" alt="Action log with activity logged" title="Action log with activity logged" />
</p>

<p><em>Action log with activity logged</em></p></li>
<li><p>Now, you will update the Filters' order value and verify how the logging order changes. In the <strong>StoreController</strong> class, update the Filters' Order value like shown below.</p>

<!-- mark:1-2    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[MyNewCustomActionFilter(Order = 1)]</strong>
<strong class="markLine">[CustomActionFilter(Order = 2)]</strong>
<span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> StoreController : Controller
{
...
}
</code></pre></li>
<li><p>Run the application again by pressing <strong>F5</strong>.</p></li>
<li><p>Click one of the <strong>Genres</strong> from the menu and perform some actions there, like browsing an available album.</p></li>
<li><p>Check that this time, the logs created by <strong>MyNewCustomActionFilter</strong> filter appears first.</p>

<p><img src="./images/Action-log-with-activity-logged4.png?raw=true" alt="Action log with activity logged" title="Action log with activity logged" />
</p>

<p><em>Action log with activity logged</em></p></li>
</ol>

<p><a name="Ex2Task4"></a></p>

<h4 id="Task_4_Registering_Filters_Globally">Task 4: Registering Filters Globally</h4>

<p>In this task, you will update the solution to register the new filter (<strong>MyNewCustomActionFilter</strong>) as a global filter. By doing this, it will be triggered by all the actions perfomed in the application and not only in the StoreController ones as in the previous task.</p>

<ol>
<li><p>In <strong>StoreController</strong> class, remove <strong>[MyNewCustomActionFilter]</strong> attribute and the order property from <strong>[CustomActionFilter]</strong>. It should look like the following:</p>

<span class="codelanguage">C#</span><pre><code class="C#">[CustomActionFilter]
<span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> StoreController : Controller
{
...
}
</code></pre></li>
<li><p>Open <strong>Global.asax</strong> file and locate the <strong>Application_Start</strong> method. Notice that each thime the application starts it is registering the global filters by calling <strong>RegisterGlobalFilters</strong> method within <strong>FilterConfig</strong> class.</p>

<p><img src="images/registering-global-filters-in-globalasax.png?raw=true" alt="Registering Global Filters in Global.asax" title="Registering Global Filters in Global.asax" />
</p>

<p><em>Registering Global Filters in Global.asax</em></p></li>
<li><p>Open <strong>FilterConfig.cs</strong> file within <strong>App_Start</strong> folder.</p></li>
<li><p>Add a reference to using System.Web.Mvc;
using MvcMusicStore.Filters; namespace.</p>

<!-- mark: 2    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System.Web.Mvc;
<strong class="markLine"><span style="color:#0000FF">using</span> MvcMusicStore.Filters;</strong>
</code></pre></li>
<li><p>Update <strong>RegisterGlobalFilters</strong> method adding your custom filter. To do this, add the highlighted code:</p>

<!-- mark: 4    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">void</span> RegisterGlobalFilters(GlobalFilterCollection filters)
{
    filters.Add(<span style="color:#0000FF">new</span> HandleErrorAttribute());
<strong class="markLine">    filters.Add(<span style="color:#0000FF">new</span> MyNewCustomActionFilter());</strong>
}
</code></pre></li>
<li><p>Run the application by pressing <strong>F5</strong>.</p></li>
<li><p>Click one of the <strong>Genres</strong> from the menu and perform some actions there, like browsing an available album.</p></li>
<li><p>Check that now <strong>[MyNewCustomActionFilter]</strong> is being injected in HomeController and ActionLogController too.</p>

<p><img src="./images/Action-log-with-activity-logged5.png?raw=true" alt="Action log with activity logged" title="Action log with activity logged" />
</p>

<p><em>Action log with global activity logged</em></p></li>
</ol>
<blockquote>
<p><strong>Note:</strong> Additionally, you can deploy this application to Windows Azure Web Sites following <a href="#AppendixB">Appendix B: Publishing an ASP.NET MVC 4 Application using Web Deploy</a>.</p>
</blockquote>
<hr />

<p><a name="Summary"></a></p>

<h2 id="Summary">Summary</h2>

<p>By completing this Hands-On Lab you have learned how to extend an action filter to execute custom actions. You have also learned how to inject any filter to your page controllers. The following concepts were used:</p>

<ul>
<li><p>How to create Custom Action filters with the ASP.NET MVC ActionFilterAttribute class</p></li>
<li><p>How to inject filters into ASP.NET MVC controllers</p></li>
<li><p>How to manage filter ordering using the Order property</p></li>
<li><p>How to register filters globally</p></li>
</ul>

<p><a name="AppendixA"></a></p>

<h2 id="Appendix_A_Installing_Visual_Studio_Express_2012_for_Web">Appendix A: Installing Visual Studio Express 2012 for Web</h2>

<p>You can install <strong>Microsoft Visual Studio Express 2012 for Web</strong> or another &quot;Express&quot; version using the <strong><a href="http://www.microsoft.com/web/downloads/platform.aspx">Microsoft Web Platform Installer</a></strong>. The following instructions guide you through the steps required to install <em>Visual studio Express 2012 for Web</em> using <em>Microsoft Web Platform Installer</em>.</p>

<ol>
<li><p>Go to <a href="http://go.microsoft.com/?linkid=9810169"><a href="http://go.microsoft.com/?linkid=9810169">http://go.microsoft.com/?linkid=9810169</a></a>. Alternatively, if you already have installed Web Platform Installer, you can open it and search for the product &quot;<em>Visual Studio Express 2012 for Web with Windows Azure SDK</em>&quot;.</p></li>
<li><p>Click on <strong>Install Now</strong>. If you do not have <strong>Web Platform Installer</strong> you will be redirected to download and install it first.</p></li>
<li><p>Once <strong>Web Platform Installer</strong> is open, click <strong>Install</strong> to start the setup.</p>

<p><img src="images/install-visual-studio-express.png?raw=true" alt="Install Visual Studio Express" title="Install Visual Studio Express" />
</p>

<p><em>Install Visual Studio Express</em></p></li>
<li><p>Read all the products' licenses and terms and click <strong>I Accept</strong> to continue.</p>

<p><img src="images/accepting-the-license-terms.png?raw=true" alt="Accepting the license terms" />
</p>

<p><em>Accepting the license terms</em></p></li>
<li><p>Wait until the downloading and installation process completes.</p>

<p><img src="images/installation-progress.png?raw=true" alt="Installation progress" />
</p>

<p><em>Installation progress</em></p></li>
<li><p>When the installation completes, click <strong>Finish</strong>.</p>

<p><img src="images/installation-completed.png?raw=true" alt="Installation completed" />
</p>

<p><em>Installation completed</em></p></li>
<li><p>Click <strong>Exit</strong> to close Web Platform Installer.</p></li>
<li><p>To open Visual Studio Express for Web, go to the <strong>Start</strong> screen and start writing &quot;<strong>VS Express</strong>&quot;, then click on the <strong>VS Express for Web</strong> tile.</p>

<p><img src="images/vs-express-for-web-tile.png?raw=true" alt="VS Express for Web tile" />
</p>

<p><em>VS Express for Web tile</em></p></li>
</ol>

<p><a name="AppendixB"></a></p>

<h2 id="Appendix_B_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy">Appendix B: Publishing an ASP.NET MVC 4 Application using Web Deploy</h2>

<p>This appendix will show you how to create a new web site from the Windows Azure Management Portal and publish the application you obtained by following the lab, taking advantage of the Web Deploy publishing feature provided by Windows Azure.</p>

<p><a name="ApxBTask1"></a></p>

<h4 id="Task_1_-_Creating_a_New_Web_Site_from_the_Windows_Azure_Portal">Task 1 - Creating a New Web Site from the Windows Azure Portal</h4>

<ol>
<li><p>Go to the <a href="https://manage.windowsazure.com/">Windows Azure Management Portal</a> and sign in using the Microsoft credentials associated with your subscription.</p>
<blockquote>
<p><strong>Note:</strong> With Windows Azure you can host 10 ASP.NET Web Sites for free and then scale as your traffic grows. You can sign up <a href="http://aka.ms/aspnet-hol-azure">here</a>.</p>
</blockquote>
<p><img src="images/login.png?raw=true" alt="Log on to Windows Azure portal" title="Log on to Windows Azure portal" />
</p>

<p><em>Log on to Windows Azure Management Portal</em></p></li>
<li><p>Click <strong>New</strong> on the command bar.</p>

<p><img src="images/new-website.png?raw=true" alt="Creating a new Web Site" title="Creating a new Web Site" />
</p>

<p><em>Creating a new Web Site</em></p></li>
<li><p>Click <strong>Compute</strong> | <strong>Web Site</strong>. Then select <strong>Quick Create</strong> option. Provide an available URL for the new web site and click <strong>Create Web Site</strong>.</p>
<blockquote>
<p><strong>Note:</strong> A Windows Azure Web Site is the host for a web application running in the cloud that you can control and manage. The Quick Create option allows you to deploy a completed web application to the Windows Azure Web Site from outside the portal. It does not include steps for setting up a database.</p>
</blockquote>
<p><img src="images/quick-create.png?raw=true" alt="Creating a new Web Site using Quick Create" title="Creating a new Web Site using Quick Create" />
</p>

<p><em>Creating a new Web Site using Quick Create</em></p></li>
<li><p>Wait until the new <strong>Web Site</strong> is created.</p></li>
<li><p>Once the Web Site is created click the link under the <strong>URL</strong> column. Check that the new Web Site is working.</p>

<p><img src="images/navigate-website.png?raw=true" alt="Browsing to the new web site" title="Browsing to the new web site" />
</p>

<p><em>Browsing to the new web site</em></p>

<p><img src="images/website-working.png?raw=true" alt="Web site running" title="Web site running" />
</p>

<p><em>Web site running</em></p></li>
<li><p>Go back to the portal and click the name of the web site under the <strong>Name</strong> column to display the management pages.</p>

<p><img src="images/go-to-the-dashboard.png?raw=true" alt="Opening the web site management pages" title="Opening the web site management pages" />
</p>

<p><em>Opening the Web Site management pages</em></p></li>
<li><p>In the <strong>Dashboard</strong> page, under the <strong>quick glance</strong> section, click the <strong>Download publish profile</strong> link.</p>
<blockquote>
<p><strong>Note:</strong> The <em>publish profile</em> contains all of the information required to publish a web application to a Windows Azure website for each enabled publication method. The publish profile contains the URLs, user credentials and database strings required to connect to and authenticate against each of the endpoints for which a publication method is enabled. <strong>Microsoft WebMatrix 2</strong>, <strong>Microsoft Visual Studio Express for Web</strong> and <strong>Microsoft Visual Studio 2012</strong> support reading publish profiles to automate configuration of these programs for publishing web applications to Windows Azure websites. </p>
</blockquote>
<p><img src="images/download-publish-profile.png?raw=true" alt="Downloading the web site publish profile" title="Downloading the web site publish profile" />
</p>

<p><em>Downloading the Web Site publish profile</em></p></li>
<li><p>Download the publish profile file to a known location. Further in this exercise you will see how to use this file to publish a web application to a Windows Azure Web Sites from Visual Studio.</p>

<p><img src="images/save-link.png?raw=true" alt="Saving the publish profile file" title="Saving the publish profile" />
</p>

<p><em>Saving the publish profile file</em></p></li>
</ol>

<p><a name="ApxBTask2"></a></p>

<h4 id="Task_2_-_Configuring_the_Database_Server">Task 2 - Configuring the Database Server</h4>

<p>If your application makes use of SQL Server databases you will need to create a SQL Database server. If you want to deploy a simple application that does not use SQL Server you might skip this task.</p>

<ol>
<li><p>You will need a SQL Database server for storing the application database. You can view the SQL Database servers from your subscription in the Windows Azure Management portal at <strong>Sql Databases</strong> | <strong>Servers</strong> | <strong>Server's Dashboard</strong>. If you do not have a server created, you can create one using the <strong>Add</strong> button on the command bar. Take note of the <strong>server name and URL, administrator login name and password</strong>, as you will use them in the next tasks. Do not create the database yet, as it will be created in a later stage.</p>

<p><img src="images/sql-database-server-dashboard.png?raw=true" alt="SQL Database Server Dashboard" title="SQL Database Server Dashboard" />
</p>

<p><em>SQL Database Server Dashboard</em></p></li>
<li><p>In the next task you will test the database connection from Visual Studio, for that reason you need to include your local IP address in the server's list of <strong>Allowed IP Addresses</strong>. To do that, click <strong>Configure</strong>, select the IP address from <strong>Current Client IP Address</strong> and paste it on the <strong>Start IP Address</strong> and <strong>End IP Address</strong> text boxes and click the <img src="images/add-client-ip-address-ok-button.png?raw=true" alt="add-client-ip-address-ok-button" />
 button.</p>

<p><img src="images/add-client-ip-address.png?raw=true" alt="Adding Client IP Address" />
</p>

<p><em>Adding Client IP Address</em></p></li>
<li><p>Once the <strong>Client IP Address</strong> is added to the allowed IP addresses list, click on <strong>Save</strong> to confirm the changes.</p>

<p><img src="images/add-client-ip-address-confirm.png?raw=true" alt="Confirm Changes" />
</p>

<p><em>Confirm Changes</em></p></li>
</ol>

<p><a name="ApxBTask3"></a></p>

<h4 id="Task_3_-_Publishing_an_ASPNET_MVC_4_Application_using_Web_Deploy">Task 3 - Publishing an ASP.NET MVC 4 Application using Web Deploy</h4>

<ol>
<li><p>Go back to the ASP.NET MVC 4 solution. In the <strong>Solution Explorer</strong>,  right-click the web site project and select <strong>Publish</strong>.</p>

<p><img src="images/publishing-the-application.png?raw=true" alt="Publishing the Application" title="Publishing the Application" />
</p>

<p><em>Publishing the web site</em></p></li>
<li><p>Import the publish profile you saved in the first task.</p>

<p><img src="images/importing-the-publish-profile.png?raw=true" alt="Importing the publish profile" title="Importing the publish profile" />
</p>

<p><em>Importing publish profile</em></p></li>
<li><p>Click <strong>Validate Connection</strong>. Once Validation is complete click <strong>Next</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Validation is complete once you see a green checkmark appear next to the Validate Connection button.</p>
</blockquote>
<p><img src="images/validating-connection.png?raw=true" alt="Validating connection" title="Validating connection" />
</p>

<p><em>Validating connection</em></p></li>
<li><p>In the <strong>Settings</strong> page, under the <strong>Databases</strong> section, click the button next to your database connection's textbox (i.e. <strong>DefaultConnection</strong>).</p>

<p><img src="images/web-deploy-configuration.png?raw=true" alt="Web deploy configuration" title="Web deploy configuration" />
</p>

<p><em>Web deploy configuration</em></p></li>
<li><p>Configure the database connection as follows:</p>

<ul>
<li>In the <strong>Server name</strong> type your SQL Database server URL using the <em>tcp:</em> prefix.</li>
<li>In <strong>User name</strong> type your server administrator login name.</li>
<li>In <strong>Password</strong> type your server administrator login password.</li>
<li>Type a new database name.</li>
</ul>

<p><img src="images/configuring-destination-connection-string.png?raw=true" alt="Configuring destination connection string" title="Configuring destination connection string" />
</p>

<p><em>Configuring destination connection string</em></p></li>
<li><p>Then click <strong>OK</strong>. When prompted to create the database click <strong>Yes</strong>.</p>

<p><img src="images/creating-the-database.png?raw=true" alt="Creating the database" title="Creating the database string" />
</p>

<p><em>Creating the database</em></p></li>
<li><p>The connection string you will use to connect to SQL Database in Windows Azure is shown within Default Connection textbox. Then click <strong>Next</strong>.</p>

<p><img src="images/sql-database-connection-string.png?raw=true" alt="Connection string pointing to SQL Database" title="Connection string pointing to SQL Database" />
</p>

<p><em>Connection string pointing to SQL Database</em></p></li>
<li><p>In the <strong>Preview</strong> page, click <strong>Publish</strong>.</p>

<p><img src="images/publishing-the-web-application.png?raw=true" alt="Publishing the web application" title="Publishing the web application" />
</p>

<p><em>Publishing the web application</em></p></li>
<li><p>Once the publishing process finishes, your default browser will open the published web site.</p></li>
</ol>

<p><a name="AppendixC"></a></p>

<h2 id="Appendix_C_Using_Code_Snippets">Appendix C: Using Code Snippets</h2>

<p>With code snippets, you have all the code you need at your fingertips. The lab document will tell you exactly when you can use them, as shown in the following figure.</p>

<p><img src="./images/Using-Visual-Studio-code-snippets-to-insert-code-into-your-project.png?raw=true" alt="Using Visual Studio code snippets to insert code into your project" title="Using Visual Studio code snippets to insert code into your project" />
</p>

<p><em>Using Visual Studio code snippets to insert code into your project</em></p>

<p><em><strong>To add a code snippet using the keyboard (C# only)</strong></em></p>

<ol>
<li><p>Place the cursor where you would like to insert the code.</p></li>
<li><p>Start typing the snippet name (without spaces or hyphens).</p></li>
<li><p>Watch as IntelliSense displays matching snippets' names.</p></li>
<li><p>Select the correct snippet (or keep typing until the entire snippet's name is selected).</p></li>
<li><p>Press the Tab key twice to insert the snippet at the cursor location.</p></li>
</ol>

<p><img src="./images/Start-typing-the-snippet-name.png?raw=true" alt="Start typing the snippet name" title="Start typing the snippet name" />
</p>

<p><em>Start typing the snippet name</em></p>

<p><img src="./images/Press-Tab-to-select-the-highlighted-snippet.png?raw=true" alt="Press Tab to select the highlighted snippet" title="Press Tab to select the highlighted snippet" />
</p>

<p><em>Press Tab to select the highlighted snippet</em></p>

<p><img src="./images/Press-Tab-again-and-the-snippet-will-expand.png?raw=true" alt="Press Tab again and the snippet will expand" title="Press Tab again and the snippet will expand" />
</p>

<p><em>Press Tab again and the snippet will expand</em></p>

<p><em><strong>To add a code snippet using the mouse (C#, Visual Basic and XML)</strong></em>
1. Right-click where you want to insert the code snippet.</p>

<ol>
<li><p>Select <strong>Insert Snippet</strong> followed by <strong>My Code Snippets</strong>.</p></li>
<li><p>Pick the relevant snippet from the list, by clicking on it.</p></li>
</ol>

<p><img src="./images/Right-click-where-you-want-to-insert-the-code-snippet-and-select-Insert-Snippet.png?raw=true" alt="Right-click where you want to insert the code snippet and select Insert Snippet" title="Right-click where you want to insert the code snippet and select Insert Snippet" />
</p>

<p><em>Right-click where you want to insert the code snippet and select Insert Snippet</em></p>

<p><img src="./images/Pick-the-relevant-snippet-from-the-list,-by-clicking-on-it.png?raw=true" alt="Pick the relevant snippet from the list, by clicking on it" title="Pick the relevant snippet from the list, by clicking on it" />
</p>

<p><em>Pick the relevant snippet from the list, by clicking on it</em></p>

</span>
		</div>
	<br />
	<p><a href="#top">top of page</a></p>
</div> 
<div class="clearBoth"></div>

        </div>
    </div>
    <div class="footer">
        <div class="microsoftLink">
            <a href="http://www.microsoft.com/" title="Microsoft">
                <img alt="Microsoft" src="images/ms-logo-footer.png" /></a>
        </div>
        <div class="leftSideLinks">
			<a href="mailto:webcamps@microsoft.com?subject=Web Camps Training Kit">Contact Us</a>&nbsp;&nbsp;|&nbsp;&nbsp;
            <a href=".\" target="_blank">Browse Content</a>&nbsp;&nbsp;|&nbsp;&nbsp;
			 &copy;&nbsp;2012 Microsoft
		 </div>
    </div>
</body>
</html>

